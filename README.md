# A Nodal tutorial on relational database

###Goal
* Building a simple schema with many-to-many relationship
* Write to the database with 3NF
* Read from database through join table

###Final Schema
![schema](https://dl.dropbox.com/s/fafkdm4xuh59vik/userGroupSchema.jpg?dl=0)

### Presentation
See the presentation slide deck [here](https://docs.google.com/presentation/d/1P_D6wj8fUKoY3dWzUA_pEQQg8kpV1b8RH-afFXWRh6Q/edit#slide=id.g142e72fdd0_0_7)

### Requirement
* Nodal v0.10.0
* Postgres
* Postman

### Get started

```sh
nodal s
```

Nodal should now be running on [localhost:3000](http://localhost:3000/).

Generated by [Nodal](http://nodaljs.com)

### Master Branch

* The master branch has the basic nodal skeleton set up
* Models and controllers have been generated for User and Group table

### Solution Branch

* The sulution branch has the model and controller for User_Group table
* An end point is set up for writing to User_Group table with foreign key
* An end point is set up for getting group names that a user belongs to

### Nodal Commands
* Create user_group table to join user and group

```
nodal g:model user_group user_id:int group_id:int
nodal g:controller v1 --for user_group
```
* Create a database in postgres and create blank tables
```
nodal db:create
nodal db:prepare
nodal db:migrate
```
* seeding the database with dummy data
```
nodal db:seed
nodal db:bootstrap
```
### Postman / API endpoints
* http://localhost:3000/v1/users
* http://localhost:3000/v1/groups
* http://localhost:3000/v1/user_groups

### Writing to database
* Modify the `user_groups_controller.js`
```javascript
    const User = Nodal.require('app/models/user.js');
    const Group = Nodal.require('app/models/group.js');

    //....

    create() {

      let user_id;
      let group_id;
      let user_group;
      const userName = { name: this.params.body.userName };
      const groupName = { name: this.params.body.groupName };

      User.findOrCreateBy("name", userName, (err, user) => {
        if ( err ) { return this.respond(err); } // make sure your handle error
        user_id = user.get('id');

        Group.findOrCreateBy("name", groupName, (err, group) => {
          if ( err ) { return this.respond(err); } // every step!!!
          group_id = group.get('id');

          user_group = { user_id, group_id };
          
          UserGroup.create(user_group, (err, userGroup) => {
            this.respond(err || userGroup);
          });

        });

      });
```
* Check with Postman
![postman](https://dl.dropbox.com/s/frr23spvdzipmqg/postToUserGroup.jpg?dl=0)
* Check with Postgres
```
$ psql -U postgres
$ \l
$ \c nodal_schema_development
$ \dt
$ SELECT * FROM users;
```

### Reading from database
* Modify the `user.js` model
```javascript
const UserGroup = Nodal.require('app/models/user_group.js');
//...
User.joinedBy(UserGroup, {multiple: true});
```
* Modify the `group.js` model
```
const UserGroup = Nodal.require('app/models/user_group.js');
//...
Group.joinedBy(UserGroup, {multiple: true});
```

* Modify the `user_group.js` model
```javascript
const Group = Nodal.require('app/models/group.js');
const User = Nodal.require('app/models/user.js');
//...
UserGroup.joinsTo(User, {multiple: true});
UserGroup.joinsTo(Group, {multiple: true});
```

* Modify the 'users_controller'
```javascript
UserGroup.query()
  .join('user')
  .join('group')
  .where(this.params.query)
  .end((err, models) => {

    this.respond(err || models, [{'user': ['id', 'name']}, {'group': ['id', 'name']}]);

  });
```
*Check with Postman
![postman](https://dl.dropbox.com/s/9dupu6qggowz6iz/readFromUserGroup.jpg?dl=0)

